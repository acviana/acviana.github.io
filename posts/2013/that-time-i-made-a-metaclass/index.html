<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>That Time I Made a Metaclass</title>
  <meta name="author" content="Alex C. Viana">



  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="http://acviana.github.io/favicon.png" rel="icon">
  <link href="http://acviana.github.io/theme/css/main.css" media="screen, projection"
        rel="stylesheet" type="text/css">
  <script src="http://acviana.github.io/theme/js/modernizr-2.0.js"></script>
  <script src="http://acviana.github.io/theme/js/ender.js"></script>
  <script src="http://acviana.github.io/theme/js/octopress.js" type="text/javascript"></script>

  <link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
  <link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
</head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="http://acviana.github.io/">The Other Side of the Screen</a></h1>
    <h2>"On the other side of the screen it all seems so easy." - Tron (1982)</h2>
</hgroup></header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://acviana.github.io/" rel="subscribe-rss">RSS</a></li>
</ul>

<!-- TODO: add search here
<form action="" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:http://acviana.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
-->

<ul class="main-navigation">
      <li><a href="http://acviana.github.io/pages/about.html">About</a></li>
      <li><a href="http://acviana.github.io/pages/disclaimer.html">Disclaimer</a></li>
    <!-- TODO: add categories here? -->
</ul></nav>
  <div id="main">
    <div id="content">
<div>
  <article class="hentry" role="article">
<header>
      <h1 class="entry-title">That Time I Made a Metaclass</h1>
      <p class="meta"><time datetime="2013-12-04T00:00:00" pubdate>2013-12-04</time></p>
</header>

  <div class="entry-content"><blockquote>
<p>"If you don't know what a metaclass is you don't need to use one."<br />
- David Beazley</p>
</blockquote>
<p>I was shooting some messages back and forth this morning with some current and former coworkers on Twitter on the topic of Python Metaclasses. One coworker said metaclasses was something he'd never really got around to using. I mentioned that I had used them exactly once to generate database Object Relational Models (ORMs). My second coworker said that was a common use case and that it would be nice to see an example. Since a tech blog is a shining example of a hammer searching for a nail I immediately got to work on this post.</p>
<h3>Some Background</h3>
<p>I took David Beazley's Python Master class in 2009 (?) and I still remembered the quote from the start of this post, so for years I didn't worry about metaclasses because I knew I didn't need them. Finally though, I did need them.</p>
<p>One of my favorite Python modules, despite its near vertical learning curve, is the <a href="http://www.sqlalchemy.org/">SQLAlchemy</a> database toolkit. One of the features in this module is a very nice Object Relational Mapper (ORM) which maps database tables to Python classes. The ORM can be used in a number of ways and I prefer to use what's called the <a href="http://docs.sqlalchemy.org/en/rel_0_9/orm/extensions/declarative.html">Declarative Base</a> syntax. The basic idea is that you create a parent class called <code>Base</code> that contains information about your database connection and metadata. All your ORM classes are then child classes of <code>Base</code> and you use them to work with your tables. Here is a basic example:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">MyTable</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Defines a SQLAlchemy ORM&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init_dict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">init_dict</span><span class="p">)</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;my_table&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">foo1</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
    <span class="n">foo2</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
    <span class="n">foo3</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
    <span class="o">...</span>
</pre></div>


<p>You could imagine an application that would need to dynamically define several of these tables, but you don't have to because I'm about to tell you about one. </p>
<h3>My Problem</h3>
<p>The most common image file format in astronomy is called <a href="http://en.wikipedia.org/wiki/FITS">FITS</a>. FITS files have multiple layers (called "extensions") each with it's own set of metadata (called "headers"). For one of my projects we have over a million FITS files and we index these files with a MySQL database that maps the header keywords in the extensions to fields in SQL tables. We have about a dozen different file types, each with a handful of extensions, and each of those has 10s of header keywords. If you spelled out every ORM explicitly with a class and an attribute for every column like we do above we would literally have thousands of rows of ORM definitions. I'm a big proponent of the DRY principle (Don't Repeat Yourself) for the sake of readability and maintainability so this was a pretty big red flag in my opinion. </p>
<h3>My Solution</h3>
<p>Notice that we don't need to dynamically create many instances of the same class. Instead we need to dynamically create many class definitions. This is the specific need the drove me to use a metaclass.I ended up with something like the code snippet below. </p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">orm_factory</span><span class="p">(</span><span class="n">class_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates SQLA ORM Classes.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init_dict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">init_dict</span><span class="p">)</span>

    <span class="n">class_attributes_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">class_attributes_dict</span><span class="p">[</span><span class="s">&#39;__init__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__init__</span>
    <span class="n">class_attributes_dict</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">class_attributes_dict</span><span class="p">[</span><span class="s">&#39;__tablename__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">class_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="n">s</span>
    <span class="n">class_attributes_dict</span><span class="o">.</span><span class="n">__update__</span><span class="p">(</span><span class="n">get_column_defs</span><span class="p">(</span><span class="n">class_name</span><span class="p">))</span>

    <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">class_name</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="p">(</span><span class="n">Base</span><span class="p">,),</span> <span class="n">class_attributes_dict</span><span class="p">)</span>
</pre></div>


<p>You could then call <code>orm_factory</code> like this:</p>
<div class="highlight"><pre><span class="n">Class1</span> <span class="o">=</span> <span class="n">orm_factory</span><span class="p">(</span><span class="s">&#39;Class1&#39;</span><span class="p">)</span>
<span class="n">Class2</span> <span class="o">=</span> <span class="n">orm_factory</span><span class="p">(</span><span class="s">&#39;Class2&#39;</span><span class="p">)</span>
<span class="n">Class3</span> <span class="o">=</span> <span class="n">orm_factory</span><span class="p">(</span><span class="s">&#39;Class3&#39;</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>


<p>And there you have your classes, dynamically created using metaclasses.</p>
<h3>Solution Breakdown</h3>
<p>Let's walk through this. First, let's look at the last line for the <code>orm_factory</code> function. This is maybe the "craziest" part of the whole function. That's because <code>type</code> is actually a metaclass constructor. That's right, the thing that tells you <code>type(1)</code> is <code>int</code> is also used as a metaclass constructor to maintain backward comparability <sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>. (If you want to tickle your brain check the type of type). To really wrap your head around metaclasses and type check out Jake VanderPlas's <a href="http://jakevdp.github.io/blog/2012/12/01/a-primer-on-python-metaclasses/">excellent post</a> on the subject. </p>
<p>The basic idea is you pass <code>type</code> the string name you would to give the constructed class, a tuple of parent classes, and a dictionary of any other attributes for the class. Looking up the code block you'll see that I create a dictionary for these attributes called <code>class_attribute_dict</code>. </p>
<p>Notice I'm doing a little bit of magic by creating a <code>get_column_defs()</code> function. This function will dynamically add the appropriate column definitions, for example by pulling them from the FITS headers. The implementation of this function isn't import to the topic of this post, what matters is that these is some dynamic aspect to the column definition (and hence the class creation) that necessitates the use of a metaclass. </p>
<p>Also, notice that the attributes in  <code>class_attribute_dict</code> includes an <code>__init__</code> method defined as a function. This is one of those weird moments in python when you define a function <em>inside</em> of another function. We do this because we're never going to use the <code>__init__</code> function outside of the <code>orm_factory</code> function it's nested in so there is no reason to globally scope it. In this case we define <code>__init__</code> just like it was a method with a reference to <code>self</code> and everything. Even though there is nothing special about this function it will still take on the properties of a method after it's passed to type. I personally think is pretty cool and give you some insight into how classes are built.</p>
<p>So that's my example of metaclasses. It took me a couple of long days to figure this all out but I learned a lot about the inner workings of Python in the process. It's not so hard once you see it, but it's also not something I anticipate having to do again soon.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>I swear I read this somewhere but I'm still hunting for the source.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div></div>
    <footer>
<p class="meta">
  <span class="byline author vcard">
    Posted by <span class="fn">Alex C. Viana</span>
  </span>
<time datetime="2013-12-04T00:00:00" pubdate>2013-12-04</time>  <span class="categories">
    <a class="category" href="http://acviana.github.io/tag/code.html">code</a>
    <a class="category" href="http://acviana.github.io/tag/python.html">python</a>
    <a class="category" href="http://acviana.github.io/tag/database.html">database</a>
  </span>
</p>    </footer>
  </article>
  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
  </section>
</div>
<aside class="sidebar">
  <section>
    <h1>Recent Posts</h1>
    <ul id="recent_posts">
      <li class="post">
          <a href="http://acviana.github.io/posts/2014/faster-file-checking-with-sets/">Faster File Existence Testing with Sets</a>
      </li>
      <li class="post">
          <a href="http://acviana.github.io/posts/2014/2014-summer-internship-opportunity/">2014 Summer Internship Opportunity</a>
      </li>
      <li class="post">
          <a href="http://acviana.github.io/posts/2013/guilty-as-charged/">Guilty As Charged</a>
      </li>
      <li class="post">
          <a href="http://acviana.github.io/posts/2013/that-time-i-made-a-metaclass/">That Time I Made a Metaclass</a>
      </li>
      <li class="post">
          <a href="http://acviana.github.io/posts/2013/the-joy-of-screen/">The Joy of "Screen"</a>
      </li>
    </ul>
  </section>
  <section>
      
    <h1>Categories</h1>
    <ul id="recent_posts">
        <li><a href="http://acviana.github.io/category/work.html">Work</a></li>
    </ul>
  </section>
 

  <section>
  <h1>Tags</h1>
    <a href="http://acviana.github.io/tag/uvis.html">uvis</a>,    <a href="http://acviana.github.io/tag/code.html">code</a>,    <a href="http://acviana.github.io/tag/humor.html">humor</a>,    <a href="http://acviana.github.io/tag/mtpipeline.html">mtpipeline</a>,    <a href="http://acviana.github.io/tag/python.html">python</a>,    <a href="http://acviana.github.io/tag/wfc3.html">wfc3</a>,    <a href="http://acviana.github.io/tag/database.html">database</a>,    <a href="http://acviana.github.io/tag/psf.html">psf</a>,    <a href="http://acviana.github.io/tag/devops.html">devops</a>,    <a href="http://acviana.github.io/tag/wfpc2.html">wfpc2</a>,    <a href="http://acviana.github.io/tag/acs.html">acs</a>,    <a href="http://acviana.github.io/tag/jwst.html">jwst</a>,    <a href="http://acviana.github.io/tag/git.html">git</a>,    <a href="http://acviana.github.io/tag/hst.html">hst</a>,    <a href="http://acviana.github.io/tag/milestones.html">milestones</a>,    <a href="http://acviana.github.io/tag/plots.html">plots</a>,    <a href="http://acviana.github.io/tag/pelican.html">pelican</a>  </section>


    <section>
        <h1>Social</h2>
        <ul>
            <li><a href="http://acviana.github.io/" type="application/rss+xml" rel="alternate">RSS</a></li>
            <li><a href="https://twitter.com/AlexVianaPro" target="_blank">Twitter</a></li>
            <li><a href="https://github.com/acviana" target="_blank">GitHub</a></li>
            <li><a href="http://www.linkedin.com/pub/alex-viana/49/1b8/83" target="_blank">LinkedIn</a></li>
            <li><a href="http://stackoverflow.com/users/1216837/acv" target="_blank">StackOverflow</a></li>
        </ul>
    </section>
    <section>
        <h1>Blogroll</h2>
        <ul>
            <li><a href="http://getpelican.com/" target="_blank">Pelican</a></li>
            <li><a href="http://python.org/" target="_blank">Python.org</a></li>
            <li><a href="http://jinja.pocoo.org/" target="_blank">Jinja2</a></li>
            <li><a href="http://software-carpentry.org/" target="_blank">Software Carpentry</a></li>
        </ul>
    </section>
</aside>    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Alex C. Viana -
  <span class="credit">Powered by <a href="http://getpelican.com">Pelican</a></span>
</p></footer>
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-45960611-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-45960611-1');
    ga('send', 'pageview');
</script>
	<script type="text/javascript">
	  var disqus_shortname = 'theothersideofthescreen';
          var disqus_identifier = '/posts/2013/that-time-i-made-a-metaclass/';
          var disqus_url = 'http://acviana.github.io/posts/2013/that-time-i-made-a-metaclass/';
          var disqus_title = 'That Time I Made a Metaclass';
	  (function() {
	    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
	    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	   })();
	</script>
</body>
</html>